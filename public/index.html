<!DOCTYPE html>
<html>
<head>
  <title>Flight Insurance UI</title>
</head>
<body>
  <h2>Available Policy</h2>
  <button onclick="getAvailablePolicy()">View Policy Details</button>
  <p id="availablePolicyStatus"></p>

  <h2>Buy Policy</h2>
  <input id="name" placeholder="Name" />
  <input id="flight" placeholder="Flight #" />
  <input id="date" type="date" />
  <input id="from" placeholder="From City" />
  <input id="to" placeholder="To City" />
  <button onclick="buy()">Buy</button>
  <p id="buyStatus"></p>

  <h2>Claim Policy</h2>
  <input id="verifyCity" placeholder="Departure City" />
  <input id="passenger" placeholder="Wallet Address" />
  <button onclick="claim()">Claim</button>
  <p id="claimStatus"></p>

  <script>
    async function getAvailablePolicy() {
      const res = await fetch('/available');
      const out = await res.json();
      document.getElementById("availablePolicyStatus").innerText = out.policy || "Error retrieving policy info.";
    }

    async function buy() {
      const data = {
        name: document.getElementById("name").value,
        flight: document.getElementById("flight").value,
        date: Math.floor(new Date(document.getElementById("date").value).getTime() / 1000),
        fromCity: document.getElementById("from").value,
        toCity: document.getElementById("to").value
      };

      if (!data.name || !data.flight || !data.date || !data.fromCity || !data.toCity) {
        alert("Please fill in all fields for purchasing.");
        return;
      }

      try {
        const res = await fetch('/buy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const out = await res.json();
        if (res.ok && out.status === "Purchased") {
          document.getElementById("buyStatus").innerText = "Policy purchased successfully!";
        } else {
          document.getElementById("buyStatus").innerText = `Failed: ${out.error || JSON.stringify(out)}`;
        }
      } catch (err) {
        document.getElementById("buyStatus").innerText = `Error: ${err.message}`;
      }
    }

    async function claim() {
      const data = {
        city: document.getElementById("verifyCity").value,
        passenger: document.getElementById("passenger").value
      };

      if (!data.city || !data.passenger) {
        alert("Please fill in both the city and passenger wallet address.");
        return;
      }

      try {
        const res = await fetch('/claim', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const out = await res.json();
        if (res.ok && out.status === "Claim processed") {
          document.getElementById("claimStatus").innerText = `Claim successful! Weather: ${out.condition}`;
        } else {
          document.getElementById("claimStatus").innerText = `Not eligible: ${out.condition || out.error}`;
        }
      } catch (err) {
        document.getElementById("claimStatus").innerText = `Error: ${err.message}`;
      }
    }
  </script>
</body>
</html>